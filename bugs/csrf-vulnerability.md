---
id: "VUL-2024-003"
title: "CSRF跨站请求伪造漏洞"
status: "unresolved"
level: "II"
discoveredAt: "2024-02-01"
category: "Web安全"
description: "关键操作缺少CSRF令牌验证，可能被恶意利用"
tags: ["CSRF", "会话安全", "令牌验证"]
---

# CSRF跨站请求伪造漏洞

## 漏洞描述

用户管理模块中的密码修改功能缺少CSRF令牌验证，攻击者可以通过诱导用户访问恶意页面来修改用户密码。

## 漏洞位置

- 文件：`/user/change-password.php`
- 影响功能：密码修改、邮箱修改、账户删除

## 攻击场景

攻击者可以创建如下恶意页面：

\`\`\`html
<form action="https://target.com/user/change-password.php" method="POST" id="malicious">
  <input type="hidden" name="new_password" value="hacked123">
  <input type="hidden" name="confirm_password" value="hacked123">
</form>
<script>document.getElementById('malicious').submit();</script>
\`\`\`

## 风险评估

使用CVSS 3.1评分：

$$CVSS = \frac{(AV \times AC \times PR \times UI) \times (C \times I \times A)}{10}$$

- **攻击向量 (AV)**: 网络 (0.85)
- **攻击复杂度 (AC)**: 低 (0.77)  
- **权限要求 (PR)**: 无 (0.85)
- **用户交互 (UI)**: 需要 (0.62)

**最终评分**: 5.4 (中等)

## 修复建议

### 1. 实施CSRF令牌

\`\`\`php
// 生成CSRF令牌
session_start();
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

// 验证CSRF令牌
if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die('CSRF token mismatch');
}
\`\`\`

### 2. 使用SameSite Cookie

\`\`\`php
setcookie('session_id', $session_id, [
    'samesite' => 'Strict',
    'secure' => true,
    'httponly' => true
]);
\`\`\`

### 3. 验证Referer头

\`\`\`php
$allowed_origins = ['https://example.com'];
$referer = $_SERVER['HTTP_REFERER'] ?? '';
if (!in_array(parse_url($referer, PHP_URL_HOST), $allowed_origins)) {
    die('Invalid referer');
}
\`\`\`

## 时间线

- **2024-02-01**: 漏洞发现
- **2024-02-02**: 风险评估完成
- **2024-02-05**: 修复方案制定
- **待定**: 修复实施

## 相关漏洞

- [VUL-2024-001](./example-vulnerability.md) - SQL注入漏洞
- [VUL-2024-002](./xss-vulnerability.md) - XSS漏洞

## 参考资料

- [OWASP CSRF Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
- [CWE-352: Cross-Site Request Forgery](https://cwe.mitre.org/data/definitions/352.html)
