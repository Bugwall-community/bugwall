---
id: "VUL-2024-004"
title: "文件上传漏洞"
status: "archived"
level: "V"
discoveredAt: "2024-01-10"
category: "文件安全"
description: "文件上传功能缺少类型和内容验证，可能导致任意代码执行"
tags: ["文件上传", "代码执行", "服务器安全"]
---

# 文件上传漏洞分析

## 漏洞概述

系统的头像上传功能存在严重安全漏洞，允许上传任意类型文件，包括可执行的PHP脚本，可能导致远程代码执行。

## 技术细节

### 漏洞代码

\`\`\`php
<?php
$target_dir = "uploads/";
$target_file = $target_dir . basename($_FILES["avatar"]["name"]);

// 仅检查文件大小，未验证文件类型
if ($_FILES["avatar"]["size"] > 500000) {
    echo "文件太大";
} else {
    move_uploaded_file($_FILES["avatar"]["tmp_name"], $target_file);
    echo "文件上传成功";
}
?>
\`\`\`

### 攻击演示

攻击者可以上传包含恶意代码的PHP文件：

\`\`\`php
<?php
// webshell.php
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>
\`\`\`

然后通过访问 `https://target.com/uploads/webshell.php?cmd=whoami` 执行系统命令。

## 影响分析

### 威胁建模

\`\`\`mermaid
graph TD
    A["攻击者"] --> B["上传恶意文件"]
    B --> C["绕过客户端验证"]
    C --> D["服务器存储文件"]
    D --> E["直接访问文件"]
    E --> F["代码执行"]
    F --> G["系统控制"]
\`\`\`

### 风险矩阵

| 威胁 | 概率 | 影响 | 风险等级 |
|------|------|------|----------|
| 远程代码执行 | 高 | 极高 | 🔴 严重 |
| 数据泄露 | 高 | 高 | 🟠 高 |
| 系统破坏 | 中 | 极高 | 🟠 高 |
| 服务中断 | 中 | 中 | 🟡 中 |

## 修复方案

### 1. 文件类型白名单

\`\`\`php
$allowed_types = ['image/jpeg', 'image/png', 'image/gif'];
$file_type = $_FILES["avatar"]["type"];

if (!in_array($file_type, $allowed_types)) {
    die("不允许的文件类型");
}
\`\`\`

### 2. 文件内容验证

\`\`\`php
$file_info = finfo_open(FILEINFO_MIME_TYPE);
$mime_type = finfo_file($file_info, $_FILES["avatar"]["tmp_name"]);
finfo_close($file_info);

if (!in_array($mime_type, $allowed_types)) {
    die("文件内容验证失败");
}
\`\`\`

### 3. 安全存储

\`\`\`php
// 生成随机文件名
$extension = pathinfo($_FILES["avatar"]["name"], PATHINFO_EXTENSION);
$new_filename = uniqid() . '.' . $extension;
$target_file = $target_dir . $new_filename;

// 存储在Web根目录外
$secure_dir = "/var/secure_uploads/";
move_uploaded_file($_FILES["avatar"]["tmp_name"], $secure_dir . $new_filename);
\`\`\`

### 4. 额外安全措施

- 设置上传目录权限为只读
- 使用CDN或对象存储服务
- 实施病毒扫描
- 添加文件大小限制

## 修复验证

### 测试用例

1. **正常文件上传测试**
   - 上传标准JPEG图片 ✅
   - 上传PNG图片 ✅
   - 上传GIF图片 ✅

2. **恶意文件拦截测试**
   - 上传PHP文件 ❌ (被拦截)
   - 上传JSP文件 ❌ (被拦截)
   - 上传可执行文件 ❌ (被拦截)

3. **绕过尝试测试**
   - 双扩展名文件 ❌ (被拦截)
   - MIME类型伪造 ❌ (被拦截)
   - 文件头伪造 ❌ (被拦截)

## 合规性检查

- ✅ OWASP Top 10 - A06:2021 Vulnerable Components
- ✅ CWE-434: Unrestricted Upload of File
- ✅ ISO 27001 - A.14.2.5 Secure system engineering principles

## 修复状态

**🗃️ 已归档** - 该功能已在2024年1月15日完全重构，采用了云存储方案

### 最终解决方案

系统已迁移至AWS S3进行文件存储，并实施了以下安全措施：

- 客户端直传S3，服务器不再处理文件上传
- S3 Bucket策略限制文件类型
- CloudFront CDN提供安全的文件访问
- 定期安全扫描和监控

## 经验教训

1. **纵深防御**: 不能仅依赖单一验证机制
2. **最小权限**: 上传目录应设置最小必要权限
3. **外部存储**: 考虑使用专业的文件存储服务
4. **持续监控**: 建立文件上传的安全监控机制

## 参考资料

- [OWASP File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
- [CWE-434: Unrestricted Upload of File with Dangerous Type](https://cwe.mitre.org/data/definitions/434.html)
- [NIST SP 800-53: Security Controls for Federal Information Systems](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final)
